---
title: "Exploratory Data Analysis for EU ETS"
output: html_notebook
---

```{r include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  arning = FALSE, 
  message = FALSE,
  fig.width=12, 
  fig.height=8)
```

This is an R notebook that documents the EDA for the EU ETS.

# Data Overview

The table below summarises the number of unique observations for different variables. There are 17,281 \* 17 = 302,957 unique installation-year.

```{r}
results %>%
  select(account_holder_id, acc_id, installation_id, com_year) %>%
  rename(
    "Account Holder ID" = account_holder_id,
    "Account ID" = acc_id,
    "Installation ID" = installation_id,
    "Compliance Year" = com_year
  ) %>%
  summarise(across(everything(), n_distinct)) %>%
  pivot_longer(everything(), names_to = "Variables", values_to = "Unique Values") %>%
  kable(align = "lc") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


The EU ETS covers both the installations and aircraft operators, with the latter being regulated starting from 2012. The two figures below show the number of regulated entities in each year for installations and aircraft operators, respectively.


```{r}
eda_bar(
  data = results %>%
    filter(!ins_isAircraftOperator & regulated) %>%
    group_by(com_year) %>%
    summarise(count = n(), .groups = "drop"),
  x_col = "com_year",
  y_col = "count",
  title = "Number of Regulated Installations",
  x_label = "Year",
  y_label = "Count",
  use_fill = FALSE,
  bar_fill = "darkslategrey"
)
```


```{r}
eda_bar(
  data = results %>%
    filter(ins_isAircraftOperator & regulated) %>%
    group_by(com_year) %>%
    summarise(count = n(), .groups = "drop"),
  x_col = "com_year",
  y_col = "count",
  title = "Number of Regulated Aircraft Operators",
  x_label = "Year",
  y_label = "Count",
  use_fill = FALSE,
  bar_fill = "lightblue"
)
```

```{r}
# Data preparation
t <- results %>%
  group_by(com_year, ins_isAircraftOperator) %>%
  summarise(
    across(
      c(com_allocatedTotal_sum, com_allocatedFree_sum, com_verified_sum), 
      ~ sum(., na.rm = TRUE)), .groups = "drop"
  ) %>%
  mutate(
    purchased = com_allocatedTotal_sum - com_allocatedFree_sum
  ) %>%
  pivot_longer(
    cols = c(com_allocatedFree_sum, purchased),
    names_to = "allocation_type",
    values_to = "amount"
  )

# Function to generate the plot for a given operator type
plot_compliance <- function(data, is_aircraft_operator) {
  operator_label <- ifelse(is_aircraft_operator, "Aircraft Operators", "Non-Aircraft Operators")
  
  # Filter data for the specified operator type
  operator_data <- data %>% filter(ins_isAircraftOperator == is_aircraft_operator)
  verified_data <- operator_data %>% distinct(com_year, com_verified_sum)
  
  # Create the plot
  ggplot(data = operator_data, aes(x = com_year)) +
    # Stacked bar chart for freely allocated and purchased allowances
    geom_bar(
      aes(y = amount, fill = allocation_type), 
      stat = "identity", position = "stack", color = "black"
    ) +
    # Line plot for total verified emissions
    geom_line(
      data = verified_data,
      aes(y = com_verified_sum, color = "Total Verified Emissions", group = 1), 
      size = 1
    ) +
    geom_point(
      data = verified_data,
      aes(y = com_verified_sum, color = "Total Verified Emissions"), 
      size = 2.5
    ) +
    geom_vline(xintercept = c("2007", "2012", "2020"), color = "darkgray", linewidth=1.5) +
    # Custom scales
    scale_fill_manual(values = c("steelblue", "darkgreen"), labels = c("Freely Allocated", "Purchased")) +
    scale_color_manual(values = c("red")) +
    labs(
      title = paste("Total Allocations and Verified Emissions (", operator_label, ")", sep = ""),
      x = "Year",
      y = "Total Amount (Tonnes)",
      fill = "Allocation Type",
      color = "Metric"
    ) +
    theme_bw() +
    theme(
      legend.position = "bottom",
      legend.title = element_blank(),
      plot.title = element_text(hjust = 0.5, face = "bold")
    )
}


print(plot_compliance(t, is_aircraft_operator = FALSE))
print(plot_compliance(t, is_aircraft_operator = TRUE))
```

```{r}
# Calculate average emission compliance by year
t <- results %>%
  select(installation_id,
         com_year, 
         com_allocatedTotal_sum, 
         com_allocatedFree_sum, 
         com_verified_sum) %>%
  rename(
    "Year" = com_year,
    "Average Allocated Allowances" = com_allocatedTotal_sum,
    "Average Freely Allocated Allowances" = com_allocatedFree_sum,
    "Average Verified Emissions" = com_verified_sum
  ) %>%
  group_by(Year) %>%
  summarise(across(everything(), ~ mean(., na.rm = TRUE))) %>%
  gather(key = "variable", value = "value", -Year)


  
### Plot the reshaped data.frame
ggplot(t, aes(x = Year, y = value, group = variable, color = variable, linetype = variable)) +
  geom_vline(xintercept = c("2007", "2012", "2020"), color = "darkgray", linewidth=1.5) +
  geom_line(lwd = 1) +
  geom_point(aes(shape = variable), size = 2.5) +
  scale_color_manual(values = c("darkred", "steelblue", "darkgreen")) +
  labs(x ="Year", y = "Tonne") +
  theme_bw() +
  theme(legend.position="bottom", legend.title = element_blank())
```